<!DOCTYPE HTML>
<html>

<head>
    <title>DICOM Viewer</title>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <!-- cornerstone css - provides some useful css classes -->
    <link href="./js/cornerstone.css" rel="stylesheet" type="text/css">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="./css/paper.min.css" rel="stylesheet" type="text/css">
    <link href="./css/font.css" rel="stylesheet" type="text/css">
    <style type="text/css">
    body {
        padding-top: 20px
    }
    </style>


    <script src="//code.jquery.com/jquery-2.1.1.js" type="text/javascript"></script>
    <script src="//cdn.jsdelivr.net/jquery.hammerjs/1.1.2/jquery.hammer-full.min.js" type="text/javascript"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="./js/cornerstone.js" type="text/javascript"></script>
    <script src="./js/cornerstonemath.js" type="text/javascript"></script>
    <script src="./js/cornerstonetools.js" type="text/javascript"></script>
    <script src="./js/utils.js" type="text/javascript"></script>
    <script src="./js/dcmImageLoader.js" type="text/javascript"></script>
    <script src="./js/dicomparser.js" type="text/javascript"></script>
    <!-- include the hammer.js library for touch gestures-->
    <script type="text/javascript">
    var maxImage = 748;
    var progress = 0;
    var currentImage = 0;
    var urls = [];
    var pageReadyTime = 0;
    var firstImageTime = 0;
    var decodeCompleteTime = 0;

    if (!String.prototype.format) {
        String.prototype.format = function() {
            var args = arguments;
            return this.replace(/{(\d+)}/g, function(match, number) {
                return typeof args[number] != 'undefined' ? args[number] : match;
            });
        };
    }

    function stackOnDrag(e) {
        var mouseMoveData = e.originalEvent.detail;
        var deltaY = mouseMoveData.deltaPoints.page.y;
        if (deltaY >= 3) {
            nextImage();
        } else if (deltaY <= -3) {
            prevImage();
        }
        return false; // false = cases jquery to preventDefault() and stopPropagation() this event
    }


    function disableAllTools(element) {
        cornerstoneTools.touchDragTool(stackOnDrag).deactivate(element);
        cornerstoneTools.panTouchDrag.deactivate(element);
        cornerstoneTools.wwwcTouchDrag.deactivate(element);
        cornerstoneTools.wwwc.deactivate(element);
        cornerstoneTools.pan.activate(element, 2); // 2 is middle mouse button
        cornerstoneTools.zoom.activate(element, 4); // 4 is right mouse button
        cornerstoneTools.probe.deactivate(element, 1);
        cornerstoneTools.length.deactivate(element, 1);
        cornerstoneTools.angle.deactivate(element, 1);
    }

    function changeImage(jelement, element, image) {
        cornerstone.displayImage(element, image);
        jelement.find(".topleft").html('Patient Name: ' + image.patientName + '<br>SomeOtherField: multi-line test');
        jelement.find(".bottomleft").text(image.sliceLocation);
    }


    function loaderInc() {
        $('#progress-bar').width((++progress / (maxImage - 1)) * 100 + '%');
        if (progress == maxImage - 1) {
            $('#progress-bar-container').css('visibility', 'hidden');
            decodeCompleteTime = Date.now();
        }
    }

    function nextImage() {
        $('#prevbtn').removeClass('disabled');
        var jelement = $("#im1");
        var element = jelement.get(0);
        if (currentImage < maxImage) {
            currentImage += 1;
            var image = cornerstone.loadAndCacheImage(urls[currentImage]).then(function(image){
                changeImage(jelement, element, image);
                if (currentImage === maxImage) {
                    $('#nextbtn').addClass('disabled');
                }
            });
        }
    }

    function prevImage() {
        $('#nextbtn').removeClass('disabled');
        var jelement = $("#im1");
        var element = jelement.get(0);
        if (currentImage > 0) {
            currentImage -= 1;
            var image = cornerstone.loadAndCacheImage(urls[currentImage]).then(function(image){
                changeImage(jelement, element, image);
                if (currentImage === 0) {
                    $('#prevbtn').addClass('disabled');
                }
            });
        }
    }

    function clearAllBtn() {
        $('#lengthbtn').removeClass('btn-primary').addClass('btn-default');
        $('#anglebtn').removeClass('btn-primary').addClass('btn-default');
        $('#pickerbtn').removeClass('btn-primary').addClass('btn-default');
        $('#wlbtn').removeClass('btn-primary').addClass('btn-default');
        $('#stackbtn').removeClass('btn-primary').addClass('btn-default');
        $('#movebtn').removeClass('btn-primary').addClass('btn-default');
    }

    function setupDicomViewer() {
        cornerstone.imageCache.setMaximumSizeBytes(1000 * 1024 * 1024);
        cornerstoneDCMJ2KImageLoader.setCallback(loaderInc);
        //  cornerstone.registerImageLoader('jpc', jpxLoadImage);
        for (var i = 0; i <= maxImage; i++) {
            var s = "000000000" + i;
            var filename = "http://jpx.jfpb.net/data/" + s.substr(s.length - 6) + ".dcm";
            urls.push("dcmj2k:" + filename);
            cornerstone.loadAndCacheImage(urls[i]);
        }
        var jelement = $("#im1");
        var element = jelement.get(0);
        cornerstone.enable(element);

        jelement.on('mousewheel DOMMouseScroll', function(e) {
            if (e.originalEvent.wheelDelta < 0 || e.originalEvent.detail > 0) {
                prevImage();
            } else {
                nextImage();
            }
            return false;
        });

        $('#wlbtn').click(function() {
            clearAllBtn();
            $(this).removeClass('btn-default').addClass('btn-primary');
            var jelement = $("#im1");
            var element = jelement.get(0);
            disableAllTools(element);
            cornerstoneTools.wwwc.activate(element, 1);
            cornerstoneTools.wwwcTouchDrag.activate(element);
        });

        $('#nextbtn').click(function() {
            nextImage();
        });

        $('#pickerbtn').click(function() {
            clearAllBtn();
            $(this).removeClass('btn-default').addClass('btn-primary');
            var jelement = $("#im1");
            var element = jelement.get(0);
            disableAllTools(element);
            cornerstoneTools.probe.activate(element, 1);
        });

        $('#movebtn').click(function() {
            clearAllBtn();
            $(this).removeClass('btn-default').addClass('btn-primary');
            var jelement = $("#im1");
            var element = jelement.get(0);
            disableAllTools(element);
            cornerstoneTools.panTouchDrag.activate(element);
        });

        $('#stackbtn').click(function() {
            clearAllBtn();
            $(this).removeClass('btn-default').addClass('btn-primary');
            var jelement = $("#im1");
            var element = jelement.get(0);
            disableAllTools(element);
            cornerstoneTools.touchDragTool(stackOnDrag).activate(element);
        });

        $('#anglebtn').click(function() {
            clearAllBtn();
            $(this).removeClass('btn-default').addClass('btn-primary');
            var jelement = $("#im1");
            var element = jelement.get(0);
            disableAllTools(element);
            cornerstoneTools.angle.activate(element, 1);
        });

        $('#lengthbtn').click(function() {
            clearAllBtn();
            $(this).removeClass('btn-default').addClass('btn-primary');
            var jelement = $("#im1");
            var element = jelement.get(0);
            disableAllTools(element);
            cornerstoneTools.length.activate(element, 1);
        });

        $('#prevbtn').click(function() {
            prevImage();
        });

        $('#stats').on("click", function() {
            if (maxImage === progress - 1) {
                var totalSize = 0;
                var totalDownloadTime = 0;
                var totalDecodeTime = 0;
                for (var i = 0; i <= maxImage; i++) {
                    var image = cornerstone.loadAndCacheImage(urls[i]).then(function(image){
                    totalSize += image.compressedFileSize;
                    totalDownloadTime += image.downloadTime;
                    totalDecodeTime += image.decodingTime;
                });
                var cacheInfo = cornerstone.imageCache.getCacheInfo();

                $('#innerStats').html(
                    "Total Downlaod time: {0} s (Avr: {1} ms) <br>".format((totalDownloadTime / 1000).toFixed(2), (totalDownloadTime / progress).toFixed(2)) +
                    "Total Decode time: {0} s (Avr: {1} ms) <br>".format((totalDecodeTime / 1000).toFixed(2), (totalDecodeTime / progress).toFixed(2)) +
                    "Total size: {0} mb (Avr: {1} kb) <br>".format((totalSize / 1024).toFixed(2), (totalSize / progress).toFixed(2)) +
                    "Time to first slice: {0} ms <br>".format((firstImageTime - pageReadyTime).toFixed(2)) +
                    "Time to finish: {0} ms <br>".format((decodeCompleteTime - pageReadyTime).toFixed(2)) +
                    "{0} image(s) in cache using {1} mb of a maximum of {2} mb <br>".format(cacheInfo.numberOfImagesCached, (cacheInfo.cacheSizeInBytes / 1024 / 1024).toFixed(0), (cacheInfo.maximumSizeInBytes / 1024 / 1024).toFixed(0))
                );
                $('#statsModal').modal('show');
            }
        }
    });


        //load first
        cornerstone.loadAndCacheImage(urls[0]).then(function(image) {
            firstImageTime = Date.now();
            changeImage(jelement, element, image);
            cornerstoneTools.mouseInput.enable(element);
            cornerstoneTools.mouseWheelInput.enable(element);
            // Enable all tools we want to use with this element
            cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
            cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
            cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
            cornerstoneTools.probe.enable(element);
            cornerstoneTools.length.enable(element);
            cornerstoneTools.ellipticalRoi.enable(element);
            cornerstoneTools.rectangleRoi.enable(element);
            cornerstoneTools.angle.enable(element);

            cornerstoneTools.touchInput.enable(element);
            cornerstoneTools.zoomTouchPinch.activate(element);
            cornerstoneTools.wwwcTouchDrag.activate(element);
        });
    }

    $(document).ready(function() {
        pageReadyTime = Date.now();
        setupDicomViewer();
    });
    </script>
</head>

<body>



    <div class="container-fluid" style="max-width:650px;">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>DICOM-J2K viewer</h4>
            </div>
            <div class="panel-body center-block">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div id="im1" data-index="0" style="width:512px;height:512px;position:relative" class="cornerstone-enabled-image center-block" oncontextmenu="return false" unselectable='on' onselectstart='return false;' onmousedown='return false;'>
                            <div class="topleft" style="position: absolute;top:7px; left:7px; color: #fff;line-height: 100%;">
                            </div>
                            <div class="topright" style="position: absolute;top:7px; right:7px; color: #fff;line-height: 100%;">
                            </div>
                            <div class="bottomright" style="position: absolute;bottom:7px; right:7px; color: #fff;line-height: 100%;">
                            </div>
                            <div class="bottomleft" style="position: absolute;bottom:7px; left:7px; color: #fff;line-height: 100%;">
                            </div>
                        </div>
                        <div id="progress-bar-container" class="progress progress-striped active center-block" style="width:512px">
                            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="row center-block">
                    <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2 text-right">
                        <button id="prevbtn" type="button" class="btn btn-default disabled">
                            <span class="glyphicon glyphicon-chevron-left"/>
                        </button>
                    </div>

                    <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 text-center">
                        <div class="btn-group ">
                            <button id="wlbtn" type="button" class="btn btn-primary">
                                <span class="glyphicon icon-dicom-contrast"></span>
                            </button>
                            <button id="pickerbtn" type="button" class="btn btn-default">
                                <span class="glyphicon glyphicon-screenshot"></span>
                            </button>
                            <button id="lengthbtn" type="button" class="btn btn-default">
                                <span class="glyphicon icon-dicom-length"></span>
                            </button>
                            <button id="anglebtn" type="button" class="btn btn-default">
                                <span class="glyphicon icon-dicom-angle"></span>
                            </button>
                            <button id="stackbtn" type="button" class="btn btn-default">
                                <span class="glyphicon icon-dicom-stack"></span>
                            </button>
                            <button id="movebtn" type="button" class="btn btn-default">
                                <span class="glyphicon icon-dicom-move"></span>
                            </button>
                        </div>
                    </div>
                    <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2 text-left">
                        <button id="nextbtn" type="button" class="btn btn-default">
                            <span class="glyphicon glyphicon-chevron-right"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="panel-footer text-right">&copy; Jean-Francois Pambrun - <a id="stats" href="javascript:void(0)">stats</a>
            </div>
        </div>
    </div>

    <!-- stats -->
    <div class="modal fade" id="statsModal" tabindex="-1" role="dialog" aria-labelledby="statsModal" aria-hidden="true">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">Download/Decode stats</h4>
                </div>
                <div class="modal-body" id='innerStats'>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
